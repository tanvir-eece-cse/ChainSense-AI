name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly security scans
    - cron: '0 0 * * 0'

jobs:
  # Static Application Security Testing (SAST)
  sast:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      # Python SAST with Bandit
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit on Backend
        run: |
          bandit -r backend/app -f json -o bandit-backend.json --severity-level medium || true
        continue-on-error: true

      - name: Run Bandit on ML Service
        run: |
          bandit -r ml-service/app -f json -o bandit-ml.json --severity-level medium || true
        continue-on-error: true

      - name: Upload Bandit Results
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: bandit-*.json

      # JavaScript/TypeScript SAST with ESLint Security
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ESLint Security Plugin
        run: |
          cd frontend
          npm install
          npm install eslint-plugin-security
        continue-on-error: true

      - name: Run ESLint Security Scan
        run: |
          cd frontend
          npx eslint src --ext .ts,.tsx --format json -o ../eslint-security.json || true
        continue-on-error: true

  # Software Composition Analysis (SCA)
  sca:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      # Python dependency scanning
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Safety
        run: pip install safety

      - name: Run Safety Check on Backend
        run: |
          cd backend
          pip install -r requirements.txt
          safety check --full-report -o json > ../safety-backend.json || true
        continue-on-error: true

      - name: Run Safety Check on ML Service
        run: |
          cd ml-service
          pip install -r requirements.txt
          safety check --full-report -o json > ../safety-ml.json || true
        continue-on-error: true

      # Node.js dependency scanning
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        run: |
          cd frontend
          npm install
          npm audit --json > ../npm-audit.json || true
        continue-on-error: true

      - name: Upload SCA Results
        uses: actions/upload-artifact@v4
        with:
          name: sca-results
          path: |
            safety-*.json
            npm-audit.json

  # Container Security Scanning
  container-scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Build Backend Image
        run: docker build -t chainsense-backend:scan ./backend || true
        continue-on-error: true

      - name: Build Frontend Image
        run: docker build -t chainsense-frontend:scan ./frontend || true
        continue-on-error: true

      - name: Build ML Service Image
        run: docker build -t chainsense-ml:scan ./ml-service || true
        continue-on-error: true

      - name: Run Trivy on Backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'chainsense-backend:scan'
          format: 'sarif'
          output: 'trivy-backend.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Run Trivy on Frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'chainsense-frontend:scan'
          format: 'sarif'
          output: 'trivy-frontend.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Run Trivy on ML Service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'chainsense-ml:scan'
          format: 'sarif'
          output: 'trivy-ml.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-backend.sarif'
          category: 'trivy-backend'
        continue-on-error: true

      - name: Upload All Trivy Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-*.sarif

  # Secret Scanning
  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          chmod +x gitleaks

      - name: Run Gitleaks
        run: |
          ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true

      - name: Upload Gitleaks Results
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results
          path: gitleaks-report.json

  # Infrastructure as Code Scanning
  iac-scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov on Kubernetes manifests
        uses: bridgecrewio/checkov-action@master
        with:
          directory: k8s/
          framework: kubernetes
          output_format: sarif
          output_file_path: checkov-k8s.sarif
        continue-on-error: true

      - name: Run Checkov on Dockerfiles
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: dockerfile
          output_format: sarif
          output_file_path: checkov-docker.sarif
        continue-on-error: true

      - name: Upload Checkov Results
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: checkov-*.sarif

  # DAST with OWASP ZAP (disabled - requires running services)
  # Uncomment and configure for staging/production environments
  # dast:
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   needs: [sast, sca, container-scan]
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Start application with Docker Compose
  #       run: docker-compose up -d && sleep 60
  #     - name: Run OWASP ZAP Baseline Scan
  #       uses: zaproxy/action-baseline@v0.10.0
  #       with:
  #         target: 'http://localhost:8000'
  #       continue-on-error: true
  #     - name: Stop application
  #       run: docker-compose down

  # Security Report Generation
  security-report:
    runs-on: ubuntu-latest
    needs: [sast, sca, container-scan, secret-scan, iac-scan]
    
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts

      - name: Generate Security Summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Date: $(date)" >> security-summary.md
          echo "" >> security-summary.md
          echo "### Artifacts Generated:" >> security-summary.md
          ls -la security-artifacts/ >> security-summary.md

      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
